---
import { getEntry } from "astro:content";
import { SignJWT } from "jose";
import crypto from "node:crypto";
import MarkdownIt from "markdown-it";
import "../../styles/global.css";

export const prerender = false;

// This is the main validation function for password protected posts

interface Env {
  HASH_KV: KVNamespace;
  TURNSTILE_SECRET: string;
  HMAC_CF_TO_VERCEL: string;
  HMAC_VERCEL_TO_CF: string;
  JWT_SECRET: string;
  VERCEL_FIREWALL_AUTH: string;
}

// Step 1: Introduce cloudflare workers runtime
const { env } = Astro.locals.runtime;
const vercelHelperUrl = "https://heartbeat.amia.work";
const md = new MarkdownIt();

let errorMsg = "";
let slug = "";
let question = "";

// Helper function for HMAC calculation
const hmacCalc = (content: string, key: string): string => {
  return crypto.createHmac("sha256", key).update(content).digest("hex");
};

// Helper function to validate turnstile response
async function validateWithRetry(
  token: string,
  secret: string,
  remoteip: string,
  maxRetries = 3,
) {
  const idempotencyKey = crypto.randomUUID();

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const formData = new FormData();

      formData.append("secret", secret);
      formData.append("response", token);
      formData.append("remoteip", remoteip);
      formData.append("idempotency_key", idempotencyKey);

      const response = await fetch(
        "https://challenges.cloudflare.com/turnstile/v0/siteverify",
        {
          method: "POST",
          body: formData,
        },
      );
      const result = await response.json();

      if (response.ok) {
        return result;
      }

      if (attempt === maxRetries) {
        return result;
      }

      await new Promise((resolve) =>
        setTimeout(resolve, Math.pow(2, attempt) * 1000),
      );
    } catch (error) {
      if (attempt === maxRetries) {
        return { success: false, "error-codes": ["internal-error"] };
      }
    }
  }
}

// Step 2: GET request: fetch question per slug
if (Astro.request.method === "GET") {
  const url = new URL(Astro.request.url);
  slug = url.searchParams.get("slug") || "";

  // 1. Return 404 if no slug
  if (!slug) {
    return new Response(null, { status: 404, statusText: "Not Found" });
  }

  const entry = await getEntry("posts", slug);

  // 2. Return 404 if no post matches slug
  if (!entry) {
    return new Response(null, { status: 404, statusText: "Not Found" });
  }

  question = md.render(entry.data.question || "Please verify your identity.");
}

// Step 3: POST request: validate password
else if (Astro.request.method === "POST") {
  // 1. Parse request body
  const formData = await Astro.request.formData();
  slug = formData.get("slug")?.toString() || "";
  const password = formData.get("inputpassword")?.toString() || "";
  const turnstileResponse =
    formData.get("cf-turnstile-response")?.toString() || "";

  // 2. Validate cloudflare turnstile response
  const ip = Astro.clientAddress;
  const TURNSTILE_SECRET = await env.TURNSTILE_SECRET.get();
  const isHuman = (await validateWithRetry(
    turnstileResponse,
    TURNSTILE_SECRET,
    ip,
  )) as TurnstileResponse;

  if (!isHuman.success) {
    errorMsg = "Captcha validation failed. Please try again.";
  }

  // 3. Get hashed value from KV storage
  else {
    const desiredHash = await env.HASH_KV.get(`pwd:${slug}`);

    if (!desiredHash) {
      errorMsg = "Content not found or not protected.";
    }

    // 4. Construct request to vercel helper
    else {
      const payload = JSON.stringify({
        inputPassword: password,
        hashedValue: desiredHash,
      });
      const VERCEL_FIREWALL_AUTH = await env.VERCEL_FIREWALL_AUTH.get();
      const HMAC_CF_TO_VERCEL = await env.HMAC_CF_TO_VERCEL.get();
      const requestSignature = hmacCalc(payload, HMAC_CF_TO_VERCEL);

      try {
        const vercelRes = await fetch(vercelHelperUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Aria-Interaction-Auth": VERCEL_FIREWALL_AUTH,
            "X-Aria-Request-Sig": requestSignature,
          },
          body: payload,
        });

        // 5. Validate vercel helper response
        if (!vercelRes.ok) {
          throw new Error(`Vercel rejected: ${vercelRes.status}`);
        }

        const responseText = await vercelRes.text();
        const responseSig = vercelRes.headers.get("X-Aria-Response-Sig");
        const HMAC_VERCEL_TO_CF = await env.HMAC_VERCEL_TO_CF.get();
        const expectedSig = hmacCalc(responseText, HMAC_VERCEL_TO_CF);

        if (responseSig !== expectedSig) {
          throw new Error("Response signature mismatch (Man-in-the-Middle?)");
        }

        const data = JSON.parse(responseText);
        if (data.success) {
          // 6. Sign a JWT token for user
          const JWT_SECRET = await env.JWT_SECRET.get();
          const secret = new TextEncoder().encode(JWT_SECRET);
          const jwt = await new SignJWT({
            access: "granted",
            slug: slug,
          })
            .setProtectedHeader({ alg: "HS256" })
            .setIssuedAt()
            .setExpirationTime("4h")
            .setSubject(slug)
            .sign(secret);

          // 7. Set cookie and redirect back to post
          const safeCookieKey = slug.replaceAll("/", "_");
          const cookieName = `post_access_${safeCookieKey}`;

          return new Response(null, {
            status: 302,
            headers: {
              Location: `/post/${slug}`,
              "Set-Cookie": `${cookieName}=${jwt}; Path=/post/${slug}; HttpOnly; Secure; SameSite=Strict; Max-Age=14400`,
            },
          });
        } else {
          errorMsg = data.errcode;
        }
      } catch (error) {
        console.error(error instanceof Error ? error.name : "UnknownError");
        errorMsg = "Verification service error. Please try again later.";
      }
    }
  }
}
---

<html lang="en">
  <head>
    <link rel="preconnect" href="https://challenges.cloudflare.com" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restricted Access</title>
    <script
      is:inline
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer></script>
  </head>
  <body>
    <div class="card">
      <h1>ðŸ”’ Protected Content</h1>
      <div
        class="prose prose-slate dark:prose-invert max-w-none"
        set:html={question}
      />
      {errorMsg && <div class="error">{errorMsg}</div>}
      <form method="POST">
        <input type="hidden" name="slug" value={slug} />
        <label for="password" style="display:none">Password</label>
        <input
          type="password"
          id="password"
          name="inputpassword"
          placeholder="Enter access code..."
          required
          autofocus
        />
        <div class="turnstile-box">
          <div
            class="cf-turnstile"
            data-sitekey="0x4AAAAAACJAeTxKo8GeSG3v"
            data-size="flexible"
          >
          </div>
        </div>
        <button type="submit">Unlock</button>
      </form>
    </div>
  </body>
</html>
